From 8baa69259417aee4a25b8f22bbf3215ad00faac5 Mon Sep 17 00:00:00 2001
From: liulanyi <2646907366@qq.com>
Date: Wed, 15 Oct 2025 22:54:43 +0800
Subject: [PATCH] check callbacks existence in onAboveWriteBufferHighWatermark
 and onBelowWriteBufferLowWatermark (#41521)

I got an envoy crash in my production
environment and the crash stack points to ActiveTcpClient::
onBelowWriteBufferLowWatermark. The envoy is using generic proxy filter
and using tcp connection pool to proxy customised protocol data. This
crash can be frequently reproduced when I benchmark with large body
request & response and kill the client connections during the test. I
check around other files, seems like check callbacks_ existence before
calling it is quite common, and I try use this fix in my environment
seems crash is solved.

Signed-off-by: liulanyi <2646907366@qq.com>
Signed-off-by: Andy Fong <andy.fong@solo.io>
---
 source/common/tcp/conn_pool.h | 12 ++++++++++--
 1 file changed, 10 insertions(+), 2 deletions(-)

diff --git source/common/tcp/conn_pool.h source/common/tcp/conn_pool.h
index 958d6dbb5a..617469be79 100644
--- source/common/tcp/conn_pool.h
+++ source/common/tcp/conn_pool.h
@@ -94,8 +94,16 @@ public:
   // Override the default's of Envoy::ConnectionPool::ActiveClient for class-specific functions.
   // Network::ConnectionCallbacks
   void onEvent(Network::ConnectionEvent event) override;
-  void onAboveWriteBufferHighWatermark() override { callbacks_->onAboveWriteBufferHighWatermark(); }
-  void onBelowWriteBufferLowWatermark() override { callbacks_->onBelowWriteBufferLowWatermark(); }
+  void onAboveWriteBufferHighWatermark() override {
+    if (callbacks_) {
+      callbacks_->onAboveWriteBufferHighWatermark();
+    }
+  }
+  void onBelowWriteBufferLowWatermark() override {
+    if (callbacks_) {
+      callbacks_->onBelowWriteBufferLowWatermark();
+    }
+  }
 
   // Undos the readDisable done in onEvent(Connected)
   void readEnableIfNew();
-- 
2.51.0

