From f98a5bee520e472e2c50b0ae6dd0377684f98834 Mon Sep 17 00:00:00 2001
From: Andy Fong <andy.fong@solo.io>
Date: Fri, 9 May 2025 17:21:27 -0400
Subject: [PATCH] asterisk-url-template-match.patch

---
 source/common/runtime/runtime_features.cc     |  1 +
 source/extensions/path/uri_template_lib/BUILD |  1 +
 .../uri_template_lib/uri_template_internal.cc | 54 +++++++++++--
 .../path/match/uri_template/library_test.cc   | 60 +++++++++++++++
 .../path/rewrite/uri_template/library_test.cc | 56 ++++++++++++++
 .../uri_template_internal_test.cc             | 77 +++++++++++++------
 tools/spelling/spelling_dictionary.txt        |  3 +
 7 files changed, 221 insertions(+), 31 deletions(-)

diff --git source/common/runtime/runtime_features.cc source/common/runtime/runtime_features.cc
index dafe75ac29..18ef2c3ac6 100644
--- source/common/runtime/runtime_features.cc
+++ source/common/runtime/runtime_features.cc
@@ -87,6 +87,7 @@ RUNTIME_GUARD(envoy_reloadable_features_uhv_preserve_url_encoded_case);
 RUNTIME_GUARD(envoy_reloadable_features_uhv_translate_backslash_to_slash);
 RUNTIME_GUARD(envoy_reloadable_features_upstream_allow_connect_with_2xx);
 RUNTIME_GUARD(envoy_reloadable_features_upstream_wait_for_response_headers_before_disabling_read);
+RUNTIME_GUARD(envoy_reloadable_features_uri_template_match_on_asterisk);
 RUNTIME_GUARD(envoy_reloadable_features_use_http3_header_normalisation);
 RUNTIME_GUARD(envoy_reloadable_features_validate_connect);
 RUNTIME_GUARD(envoy_reloadable_features_validate_detailed_override_host_statuses);
diff --git source/extensions/path/uri_template_lib/BUILD source/extensions/path/uri_template_lib/BUILD
index dfea1c17ec..3f3b12d78c 100644
--- source/extensions/path/uri_template_lib/BUILD
+++ source/extensions/path/uri_template_lib/BUILD
@@ -34,6 +34,7 @@ envoy_cc_library(
     srcs = ["uri_template_internal.cc"],
     hdrs = ["uri_template_internal.h"],
     deps = [
+        "//source/common/runtime:runtime_features_lib",
         "@com_google_absl//absl/container:flat_hash_set",
         "@com_google_absl//absl/flags:flag",
         "@com_google_absl//absl/functional:function_ref",
diff --git source/extensions/path/uri_template_lib/uri_template_internal.cc source/extensions/path/uri_template_lib/uri_template_internal.cc
index 0b636fb2f7..09669b0803 100644
--- source/extensions/path/uri_template_lib/uri_template_internal.cc
+++ source/extensions/path/uri_template_lib/uri_template_internal.cc
@@ -6,6 +6,8 @@
 #include <variant>
 #include <vector>
 
+#include "source/common/runtime/runtime_features.h"
+
 #include "absl/container/flat_hash_set.h"
 #include "absl/flags/flag.h"
 #include "absl/functional/function_ref.h"
@@ -43,6 +45,16 @@ constexpr absl::string_view kLiteral = "a-zA-Z0-9-._~" // Unreserved
                                        "!$&'()+,;"     // sub-delims excluding *=
                                        ":@";
 
+// Additional literal that allows "*" in the pattern.
+// This should replace "kLiteral" after removal of
+// "reloadable_features.uri_template_match_on_asterisk" runtime guard.
+// Valid pchar from https://datatracker.ietf.org/doc/html/rfc3986#appendix-A
+constexpr absl::string_view kLiteralWithAsterisk = "a-zA-Z0-9-._~" // Unreserved
+                                                   "%"             // pct-encoded
+                                                   "!$&'()+,;"     // sub-delims excluding *=
+                                                   ":@"
+                                                   "*"; // reserved characters
+
 // Default operator used for the variable when none specified.
 constexpr Operator kDefaultVariableOperator = Operator::PathGlob;
 
@@ -119,17 +131,30 @@ std::string ParsedPathPattern::debugString() const {
 }
 
 bool isValidLiteral(absl::string_view literal) {
+  static const std::string* kValidLiteralRegexAsterisk =
+      new std::string(absl::StrCat("^[", kLiteralWithAsterisk, "]+$"));
   static const std::string* kValidLiteralRegex =
       new std::string(absl::StrCat("^[", kLiteral, "]+$"));
+  static const LazyRE2 literal_regex_asterisk = {kValidLiteralRegexAsterisk->data()};
   static const LazyRE2 literal_regex = {kValidLiteralRegex->data()};
-  return RE2::FullMatch(literal, *literal_regex);
+
+  return Runtime::runtimeFeatureEnabled("envoy.reloadable_features.uri_template_match_on_asterisk")
+             ? RE2::FullMatch(literal, *literal_regex_asterisk)
+             : RE2::FullMatch(literal, *literal_regex);
 }
 
 bool isValidRewriteLiteral(absl::string_view literal) {
   static const std::string* kValidLiteralRegex =
       new std::string(absl::StrCat("^[", kLiteral, "/]+$"));
+  static const std::string* kValidLiteralRegexAsterisk =
+      new std::string(absl::StrCat("^[", kLiteralWithAsterisk, "/]+$"));
+
   static const LazyRE2 literal_regex = {kValidLiteralRegex->data()};
-  return RE2::FullMatch(literal, *literal_regex);
+  static const LazyRE2 literal_regex_asterisk = {kValidLiteralRegexAsterisk->data()};
+
+  return Runtime::runtimeFeatureEnabled("envoy.reloadable_features.uri_template_match_on_asterisk")
+             ? RE2::FullMatch(literal, *literal_regex_asterisk)
+             : RE2::FullMatch(literal, *literal_regex);
 }
 
 bool isValidVariableName(absl::string_view variable) {
@@ -351,11 +376,26 @@ std::string toRegexPattern(absl::string_view pattern) {
 std::string toRegexPattern(Operator pattern) {
   static const std::string* kPathGlobRegex = new std::string(absl::StrCat("[", kLiteral, "]+"));
   static const std::string* kTextGlobRegex = new std::string(absl::StrCat("[", kLiteral, "/]*"));
-  switch (pattern) {
-  case Operator::PathGlob: // "*"
-    return *kPathGlobRegex;
-  case Operator::TextGlob: // "**"
-    return *kTextGlobRegex;
+
+  static const std::string* kPathGlobRegexAsterisk =
+      new std::string(absl::StrCat("[", kLiteralWithAsterisk, "]+"));
+  static const std::string* kTextGlobRegexAsterisk =
+      new std::string(absl::StrCat("[", kLiteralWithAsterisk, "/]*"));
+
+  if (Runtime::runtimeFeatureEnabled("envoy.reloadable_features.uri_template_match_on_asterisk")) {
+    switch (pattern) {
+    case Operator::PathGlob: // "*"
+      return *kPathGlobRegexAsterisk;
+    case Operator::TextGlob: // "**"
+      return *kTextGlobRegexAsterisk;
+    }
+  } else {
+    switch (pattern) {
+    case Operator::PathGlob: // "*"
+      return *kPathGlobRegex;
+    case Operator::TextGlob: // "**"
+      return *kTextGlobRegex;
+    }
   }
   return "";
 }
diff --git test/extensions/path/match/uri_template/library_test.cc test/extensions/path/match/uri_template/library_test.cc
index ca10ecf37e..71c14cfb19 100644
--- test/extensions/path/match/uri_template/library_test.cc
+++ test/extensions/path/match/uri_template/library_test.cc
@@ -43,6 +43,66 @@ TEST(MatchTest, BasicUsage) {
   EXPECT_TRUE(matcher->match("/bar/en/us"));
 }
 
+TEST(MatchTest, MatchSingleAsteriskInWildcard) {
+  const std::string yaml_string = R"EOF(
+      name: envoy.path.match.uri_template.uri_template_matcher
+      typed_config:
+        "@type": type.googleapis.com/envoy.extensions.path.match.uri_template.v3.UriTemplateMatchConfig
+        path_template: "/bar/{lang}/{country=**}"
+)EOF";
+
+  Router::PathMatcherSharedPtr matcher = createMatcherFromYaml(yaml_string);
+  EXPECT_EQ(matcher->uriTemplate(), "/bar/{lang}/{country=**}");
+  EXPECT_EQ(matcher->name(), "envoy.path.match.uri_template.uri_template_matcher");
+
+  EXPECT_TRUE(matcher->match("/bar/en/us*"));
+}
+
+TEST(MatchTest, MatchDoubleAsteriskInWildcard) {
+  const std::string yaml_string = R"EOF(
+      name: envoy.path.match.uri_template.uri_template_matcher
+      typed_config:
+        "@type": type.googleapis.com/envoy.extensions.path.match.uri_template.v3.UriTemplateMatchConfig
+        path_template: "/bar/{lang}/{country=**}"
+)EOF";
+
+  Router::PathMatcherSharedPtr matcher = createMatcherFromYaml(yaml_string);
+  EXPECT_EQ(matcher->uriTemplate(), "/bar/{lang}/{country=**}");
+  EXPECT_EQ(matcher->name(), "envoy.path.match.uri_template.uri_template_matcher");
+
+  EXPECT_TRUE(matcher->match("/bar/en/us**"));
+}
+
+TEST(MatchTest, MatchSingleAsterisk) {
+  const std::string yaml_string = R"EOF(
+      name: envoy.path.match.uri_template.uri_template_matcher
+      typed_config:
+        "@type": type.googleapis.com/envoy.extensions.path.match.uri_template.v3.UriTemplateMatchConfig
+        path_template: "/bar/{lang}/{country=**}"
+)EOF";
+
+  Router::PathMatcherSharedPtr matcher = createMatcherFromYaml(yaml_string);
+  EXPECT_EQ(matcher->uriTemplate(), "/bar/{lang}/{country=**}");
+  EXPECT_EQ(matcher->name(), "envoy.path.match.uri_template.uri_template_matcher");
+
+  EXPECT_TRUE(matcher->match("/bar/en*/us"));
+}
+
+TEST(MatchTest, MatchDoubleAsterisk) {
+  const std::string yaml_string = R"EOF(
+      name: envoy.path.match.uri_template.uri_template_matcher
+      typed_config:
+        "@type": type.googleapis.com/envoy.extensions.path.match.uri_template.v3.UriTemplateMatchConfig
+        path_template: "/bar/{lang}/{country=**}"
+)EOF";
+
+  Router::PathMatcherSharedPtr matcher = createMatcherFromYaml(yaml_string);
+  EXPECT_EQ(matcher->uriTemplate(), "/bar/{lang}/{country=**}");
+  EXPECT_EQ(matcher->name(), "envoy.path.match.uri_template.uri_template_matcher");
+
+  EXPECT_TRUE(matcher->match("/bar/en**/us"));
+}
+
 } // namespace Match
 } // namespace UriTemplate
 } // namespace Extensions
diff --git test/extensions/path/rewrite/uri_template/library_test.cc test/extensions/path/rewrite/uri_template/library_test.cc
index bddbea1f39..44d07665e3 100644
--- test/extensions/path/rewrite/uri_template/library_test.cc
+++ test/extensions/path/rewrite/uri_template/library_test.cc
@@ -71,6 +71,62 @@ TEST(RewriteTest, BasicUsage) {
   EXPECT_EQ(rewriter->name(), "envoy.path.rewrite.uri_template.uri_template_rewriter");
 }
 
+TEST(RewriteTest, SingleAsteriskAtEndOfPath) {
+  const std::string yaml_string = R"EOF(
+      name: envoy.path.rewrite.uri_template.uri_template_rewriter
+      typed_config:
+        "@type": type.googleapis.com/envoy.extensions.path.rewrite.uri_template.v3.UriTemplateRewriteConfig
+        path_template_rewrite: "/bar/{country}/{final}"
+)EOF";
+
+  Router::PathRewriterSharedPtr rewriter = createRewriterFromYaml(yaml_string);
+  EXPECT_EQ(rewriter->rewritePath("/bar/usa/final*1", "/bar/{final}/{country}").value(),
+            "/bar/final*1/usa");
+  EXPECT_EQ(rewriter->name(), "envoy.path.rewrite.uri_template.uri_template_rewriter");
+}
+
+TEST(RewriteTest, SingleAsterisk) {
+  const std::string yaml_string = R"EOF(
+      name: envoy.path.rewrite.uri_template.uri_template_rewriter
+      typed_config:
+        "@type": type.googleapis.com/envoy.extensions.path.rewrite.uri_template.v3.UriTemplateRewriteConfig
+        path_template_rewrite: "/bar/{country}/final"
+)EOF";
+
+  Router::PathRewriterSharedPtr rewriter = createRewriterFromYaml(yaml_string);
+  EXPECT_EQ(rewriter->rewritePath("/bar/usa*/final", "/bar/{country}/final").value(),
+            "/bar/usa*/final");
+  EXPECT_EQ(rewriter->name(), "envoy.path.rewrite.uri_template.uri_template_rewriter");
+}
+
+TEST(RewriteTest, DoubleAsteriskAtEndOfPath) {
+  const std::string yaml_string = R"EOF(
+      name: envoy.path.rewrite.uri_template.uri_template_rewriter
+      typed_config:
+        "@type": type.googleapis.com/envoy.extensions.path.rewrite.uri_template.v3.UriTemplateRewriteConfig
+        path_template_rewrite: "/bar/{country}/{final}"
+)EOF";
+
+  Router::PathRewriterSharedPtr rewriter = createRewriterFromYaml(yaml_string);
+  EXPECT_EQ(rewriter->rewritePath("/bar/usa/final**1", "/bar/{final}/{country}").value(),
+            "/bar/final**1/usa");
+  EXPECT_EQ(rewriter->name(), "envoy.path.rewrite.uri_template.uri_template_rewriter");
+}
+
+TEST(RewriteTest, DoubleAsterisk) {
+  const std::string yaml_string = R"EOF(
+      name: envoy.path.rewrite.uri_template.uri_template_rewriter
+      typed_config:
+        "@type": type.googleapis.com/envoy.extensions.path.rewrite.uri_template.v3.UriTemplateRewriteConfig
+        path_template_rewrite: "/bar/{country}/final"
+)EOF";
+
+  Router::PathRewriterSharedPtr rewriter = createRewriterFromYaml(yaml_string);
+  EXPECT_EQ(rewriter->rewritePath("/bar/usa**/final", "/bar/{country}/final").value(),
+            "/bar/usa**/final");
+  EXPECT_EQ(rewriter->name(), "envoy.path.rewrite.uri_template.uri_template_rewriter");
+}
+
 TEST(RewriteTest, PatternNotMatched) {
   const std::string yaml_string = R"EOF(
       name: envoy.path.rewrite.uri_template.uri_template_rewriter
diff --git test/extensions/path/uri_template_lib/uri_template_internal_test.cc test/extensions/path/uri_template_lib/uri_template_internal_test.cc
index dff0e2283a..d3c828c94f 100644
--- test/extensions/path/uri_template_lib/uri_template_internal_test.cc
+++ test/extensions/path/uri_template_lib/uri_template_internal_test.cc
@@ -11,6 +11,7 @@
 
 #include "test/test_common/logging.h"
 #include "test/test_common/status_utility.h"
+#include "test/test_common/test_runtime.h"
 #include "test/test_common/utility.h"
 
 #include "absl/strings/str_cat.h"
@@ -29,6 +30,10 @@ namespace {
 using ::Envoy::StatusHelpers::StatusIs;
 
 TEST(InternalParsing, ParsedPathDebugString) {
+  TestScopedRuntime scoped_runtime;
+  scoped_runtime.mergeValues(
+      {{"envoy.reloadable_features.uri_template_match_on_asterisk", "true"}});
+
   ParsedPathPattern patt1 = {
       {
           "abc",
@@ -49,14 +54,23 @@ TEST(InternalParsing, ParsedPathDebugString) {
   EXPECT_EQ(patt2.debugString(), "/{var}");
 }
 
+TEST(InternalParsing, IsValidLiteralAsteriskDisabled) {
+  TestScopedRuntime scoped_runtime;
+  scoped_runtime.mergeValues(
+      {{"envoy.reloadable_features.uri_template_match_on_asterisk", "false"}});
+
+  EXPECT_FALSE(isValidLiteral("ab*c"));
+  EXPECT_FALSE(isValidLiteral("a**c"));
+}
+
 TEST(InternalParsing, isValidLiteralWorks) {
   EXPECT_TRUE(isValidLiteral("123abcABC"));
   EXPECT_TRUE(isValidLiteral("._~-"));
   EXPECT_TRUE(isValidLiteral("-._~%20!$&'()+,;:@"));
   EXPECT_FALSE(isValidLiteral("`~!@#$%^&()-_+;:,<.>'\"\\| "));
   EXPECT_FALSE(isValidLiteral("abc/"));
-  EXPECT_FALSE(isValidLiteral("ab*c"));
-  EXPECT_FALSE(isValidLiteral("a**c"));
+  EXPECT_TRUE(isValidLiteral("ab*c"));
+  EXPECT_TRUE(isValidLiteral("a**c"));
   EXPECT_FALSE(isValidLiteral("a=c"));
   EXPECT_FALSE(isValidLiteral("?abc"));
   EXPECT_FALSE(isValidLiteral("?a=c"));
@@ -65,6 +79,14 @@ TEST(InternalParsing, isValidLiteralWorks) {
   EXPECT_FALSE(isValidLiteral("{abc}"));
 }
 
+TEST(InternalParsing, IsValidRewriteAsteriskDisabled) {
+  TestScopedRuntime scoped_runtime;
+  scoped_runtime.mergeValues(
+      {{"envoy.reloadable_features.uri_template_match_on_asterisk", "false"}});
+
+  EXPECT_FALSE(isValidRewriteLiteral("a*c"));
+}
+
 TEST(InternalParsing, IsValidRewriteLiteralWorks) {
   EXPECT_TRUE(isValidRewriteLiteral("123abcABC"));
   EXPECT_TRUE(isValidRewriteLiteral("abc/"));
@@ -76,6 +98,7 @@ TEST(InternalParsing, IsValidRewriteLiteralWorks) {
   EXPECT_FALSE(isValidRewriteLiteral("ab}c"));
   EXPECT_FALSE(isValidRewriteLiteral("ab{c"));
   EXPECT_FALSE(isValidRewriteLiteral("a=c"));
+  EXPECT_TRUE(isValidRewriteLiteral("a*c"));
   EXPECT_FALSE(isValidRewriteLiteral("?a=c"));
 }
 
@@ -150,7 +173,7 @@ class ParseVariableFailure : public testing::TestWithParam<std::string> {};
 
 INSTANTIATE_TEST_SUITE_P(ParseVariableFailureTestSuite, ParseVariableFailure,
                          testing::Values("{var", "{=abc}", "{_var=*}", "{1v}", "{1v=abc}",
-                                         "{var=***}", "{v-a-r}", "{var=*/abc?q=1}", "{var=abc/a*}",
+                                         "{var=***}", "{v-a-r}", "{var=*/abc?q=1}",
                                          "{var=*def/abc}", "{var=}", "{var=abc=def}",
                                          "{rc=||||(A+yl/}", "/"));
 
@@ -190,15 +213,13 @@ class ParsePathPatternSyntaxFailure : public testing::TestWithParam<std::string>
 
 INSTANTIATE_TEST_SUITE_P(
     ParsePathPatternSyntaxFailureTestSuite, ParsePathPatternSyntaxFailure,
-    testing::Values("/api/v*/1234", "/api/{version=v*}/1234", "/api/v{versionNum=*}/1234",
-                    "/api/{version=*beta}/1234", "/media/eff456/ll-sd-out.{ext}",
-                    "/media/eff456/ll-sd-out.{ext=*}", "/media/eff456/ll-sd-out.**",
-                    "/media/{country=**}/{lang=*}/**", "/media/**/*/**", "/link/{id=*}/asset*",
-                    "/link/{id=*}/{asset=asset*}", "/media/{id=/*}/*", "/media/{contentId=/**}",
-                    "/api/{version}/{version}", "/api/{version.major}/{version.minor}",
-                    "/media/***", "/media/*{*}*", "/media/{*}/", "/media/*/index?a=2", "media",
-                    "/\001\002\003\004\005\006\007", "/*(/**", "/**/{var}",
-                    "/{var1}/{var2}/{var3}/{var4}/{var5}/{var6}", "/{=*}",
+    testing::Values("/api/v{versionNum=*}/1234", "/api/{version=*beta}/1234",
+                    "/media/eff456/ll-sd-out.{ext}", "/media/eff456/ll-sd-out.{ext=*}",
+                    "/media/{country=**}/{lang=*}/**", "/media/**/*/**", "/media/{id=/*}/*",
+                    "/media/{contentId=/**}", "/api/{version}/{version}",
+                    "/api/{version.major}/{version.minor}", "/media/*{*}*", "/media/{*}/",
+                    "/media/*/index?a=2", "media", "/\001\002\003\004\005\006\007", "/*(/**",
+                    "/**/{var}", "/{var1}/{var2}/{var3}/{var4}/{var5}/{var6}", "/{=*}",
                     "/{var12345678901234=*}"));
 
 TEST_P(ParsePathPatternSyntaxFailure, ParsePathPatternSyntaxFailureTest) {
@@ -267,34 +288,43 @@ TEST(InternalRegexGen, DollarSignMatchesIfself) {
   EXPECT_FALSE(RE2::FullMatch("abc", toRegexPattern("abc$")));
 }
 
-TEST(InternalRegexGen, OperatorRegexPattern) {
+TEST(InternalRegexGen, OperatorRegexPatternAsteriskDisabled) {
+  TestScopedRuntime scoped_runtime;
+  scoped_runtime.mergeValues(
+      {{"envoy.reloadable_features.uri_template_match_on_asterisk", "false"}});
+
   EXPECT_EQ(toRegexPattern(Operator::PathGlob), "[a-zA-Z0-9-._~%!$&'()+,;:@]+");
   EXPECT_EQ(toRegexPattern(Operator::TextGlob), "[a-zA-Z0-9-._~%!$&'()+,;:@/]*");
 }
 
+TEST(InternalRegexGen, OperatorRegexPattern) {
+  EXPECT_EQ(toRegexPattern(Operator::PathGlob), "[a-zA-Z0-9-._~%!$&'()+,;:@*]+");
+  EXPECT_EQ(toRegexPattern(Operator::TextGlob), "[a-zA-Z0-9-._~%!$&'()+,;:@*/]*");
+}
+
 TEST(InternalRegexGen, PathGlobRegex) {
   EXPECT_TRUE(RE2::FullMatch("abc.123", toRegexPattern(Operator::PathGlob)));
   EXPECT_FALSE(RE2::FullMatch("", toRegexPattern(Operator::PathGlob)));
   EXPECT_FALSE(RE2::FullMatch("abc/123", toRegexPattern(Operator::PathGlob)));
-  EXPECT_FALSE(RE2::FullMatch("*", toRegexPattern(Operator::PathGlob)));
-  EXPECT_FALSE(RE2::FullMatch("**", toRegexPattern(Operator::PathGlob)));
-  EXPECT_FALSE(RE2::FullMatch("abc*123", toRegexPattern(Operator::PathGlob)));
+  EXPECT_TRUE(RE2::FullMatch("*", toRegexPattern(Operator::PathGlob)));
+  EXPECT_TRUE(RE2::FullMatch("**", toRegexPattern(Operator::PathGlob)));
+  EXPECT_TRUE(RE2::FullMatch("abc*123", toRegexPattern(Operator::PathGlob)));
 }
 
 TEST(InternalRegexGen, TextGlobRegex) {
   EXPECT_TRUE(RE2::FullMatch("abc.123", toRegexPattern(Operator::TextGlob)));
   EXPECT_TRUE(RE2::FullMatch("", toRegexPattern(Operator::TextGlob)));
   EXPECT_TRUE(RE2::FullMatch("abc/123", toRegexPattern(Operator::TextGlob)));
-  EXPECT_FALSE(RE2::FullMatch("*", toRegexPattern(Operator::TextGlob)));
-  EXPECT_FALSE(RE2::FullMatch("**", toRegexPattern(Operator::TextGlob)));
-  EXPECT_FALSE(RE2::FullMatch("abc*123", toRegexPattern(Operator::TextGlob)));
+  EXPECT_TRUE(RE2::FullMatch("*", toRegexPattern(Operator::TextGlob)));
+  EXPECT_TRUE(RE2::FullMatch("**", toRegexPattern(Operator::TextGlob)));
+  EXPECT_TRUE(RE2::FullMatch("abc*123", toRegexPattern(Operator::TextGlob)));
 }
 
 TEST(InternalRegexGen, VariableRegexPattern) {
-  EXPECT_EQ(toRegexPattern(Variable("var1", {})), "(?P<var1>[a-zA-Z0-9-._~%!$&'()+,;:@]+)");
+  EXPECT_EQ(toRegexPattern(Variable("var1", {})), "(?P<var1>[a-zA-Z0-9-._~%!$&'()+,;:@*]+)");
   EXPECT_EQ(toRegexPattern(Variable("var2", {Operator::PathGlob, "abc", Operator::TextGlob})),
-            "(?P<var2>[a-zA-Z0-9-._~%!$&'()+,;:@]+/abc/"
-            "[a-zA-Z0-9-._~%!$&'()+,;:@/]*)");
+            "(?P<var2>[a-zA-Z0-9-._~%!$&'()+,;:@*]+/abc/"
+            "[a-zA-Z0-9-._~%!$&'()+,;:@*/]*)");
 }
 
 TEST(InternalRegexGen, VariableRegexDefaultMatch) {
@@ -456,8 +486,7 @@ INSTANTIATE_TEST_SUITE_P(GenPatternRegexWithoutMatchTestSuite, GenPatternRegexWi
                               {"/media/eff456/ll-sd-out.js", "/media/*"},
                               {"/api/v1/1234/", "/api/*/v1/*"},
                               {"/api/v1/1234/broadcasts/get", "/api/*/{resource=*}/{method=*}"},
-                              {"/api/v1/1234/", "/api/*/v1/**"},
-                              {"/api/*/1234/", "/api/*/1234/"}})));
+                              {"/api/v1/1234/", "/api/*/v1/**"}})));
 
 TEST_P(GenPatternRegexWithoutMatch, WithCapture) {
   absl::StatusOr<ParsedPathPattern> pattern = parsePathPatternSyntax(pathPattern());
diff --git tools/spelling/spelling_dictionary.txt tools/spelling/spelling_dictionary.txt
index a91f8e605f..402b688209 100644
--- tools/spelling/spelling_dictionary.txt
+++ tools/spelling/spelling_dictionary.txt
@@ -712,6 +712,8 @@ enqueues
 enum
 enums
 environ
+eu
+euprod
 epoll
 errno
 etag
@@ -1028,6 +1030,7 @@ pcall
 pcap
 pchar
 pclose
+pdf
 performant
 pfctl
 pipelined
-- 
2.49.0

